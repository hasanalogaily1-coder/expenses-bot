// دالة لتنسيق الأرقام مع فواصل (مثال: 50000 -> 50,000)
function formatMoney(amount) {
    if (!amount) return "0";
    // يحول الرقم إلى صيغة نصية مع فواصل
    return parseFloat(amount).toLocaleString('en-US');
}

// --- استلام البيانات من الويب هوك ---
// في n8n، البيانات القادمة من Webhook تكون داخل items[0].json.body
const inputData = items[0].json.body;
 
// 1. قراءة نوع العملية وتحديد المسار (مصاريف أم واردات)
const formType = inputData.type; // يقرأ "مصاريف" أو "داخل"
let systemType = "expense"; // القيمة الافتراضية

if (formType === "داخل" || formType === "واردات" || formType === "income") {
    systemType = "income";
} else {
    systemType = "expense";
}

// 2. استخراج البيانات مباشرة (تنظيف البيانات)
// التعديل: إزالة النصوص الافتراضية (مثل "لا يوجد تفاصيل") وتركها فارغة ""
const reason = inputData.reason || "";
const name = inputData.name || "";
const rawAmount = inputData.amount || 0;
const amount = parseFloat(rawAmount); // التأكد من أنه رقم
const formattedAmount = formatMoney(amount); // نسخة منسقة للعرض (مع فواصل)

// معالجة رقم الدار: نتأكد من إزالة كلمة "عام" إذا وصلت من الفورمة القديمة
let houseNum = inputData.houseNum || ""; 
if (houseNum === "عام") {
    houseNum = "";
}

// 3. معالجة التاريخ
// الفورمة ترسل التاريخ بصيغة YYYY-MM-DD جاهزة
let date = inputData.date;

// إعداد توقيت بغداد (لغرض وقت الإنشاء)
const now = new Date();
now.setHours(now.getHours() + 3); 

// إذا كان التاريخ فارغاً، نستخدم تاريخ اليوم
if (!date) {
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    date = `${yyyy}-${mm}-${dd}`;
}

// 4. وقت الإنشاء الكامل (Timestamp)
const yyyyNow = now.getFullYear();
const mmNow = String(now.getMonth() + 1).padStart(2, '0');
const ddNow = String(now.getDate()).padStart(2, '0');
const hhNow = String(now.getHours()).padStart(2, '0');
const minNow = String(now.getMinutes()).padStart(2, '0');
const ssNow = String(now.getSeconds()).padStart(2, '0');
const createdAt = `${yyyyNow}-${mmNow}-${ddNow} ${hhNow}:${minNow}:${ssNow}`;

// 5. معلومات المُدخل (لسجل النشاطات)
const senderName = inputData.sender_name || "";
const senderUser = inputData.sender_username ? `@${inputData.sender_username}` : "";
const entryBy = `${senderName} ${senderUser}`.trim() || "Web Form";

// 6. استخراج Chat ID للرد (مهم جداً للرد الديناميكي)
// نستخدم الآيدي القادم من الفورمة، وإذا لم يوجد نستخدم الآيدي الخاص بك كاحتياط
const targetChatId = inputData.user_id || "5762584781"; 

// --- إرجاع النتائج ---
return {
    json: {
        // أنواع العملية للفلترة (Switch Node)
        type: systemType,       // 'income' or 'expense'
        original_type: formType, // 'داخل' or 'مصاريف'
        
        // البيانات الأساسية
        reason: reason,
        name: name,
        amount: amount,                 // رقم صافي للحسابات
        formatted_amount: formattedAmount, // رقم مع فواصل للعرض في الرسائل
        
        // التواريخ والعناوين
        date: date,
        house_number: houseNum,
        created_at: createdAt,
        
        // بيانات المستخدم والرد
        entry_by: entryBy,
        chat_id: targetChatId,
        
        // مفتاح فريد لمنع التكرار (اختياري)
        unique_check: `${houseNum}-${amount}-${date}-${systemType}`
    }
};
